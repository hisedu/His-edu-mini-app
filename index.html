<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–î–ó. –∏—Å—Ç–æ—Ä–∏—è.6–∫–ª–∞—Å—Å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram WebApp */
        body {
            font-family: sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .screen-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            padding: 15px;
            box-sizing: border-box;
        }
        .menu-btn, .quiz-btn, .final-quiz-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .menu-btn {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
        }
        .menu-btn:nth-child(1) { background-color: #007bff; } /* –°–∏–Ω–∏–π */
        .menu-btn:nth-child(2), .menu-btn:nth-child(3) { background-color: #ffc107; color: #000; } /* –ñ–µ–ª—Ç—ã–π */
        .menu-btn:nth-child(4) { background-color: #9c27b0; } /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        .menu-btn:nth-child(5) { background-color: #28a745; } /* –ó–µ–ª–µ–Ω—ã–π */
        .menu-btn:nth-child(6) { background-color: #fd7e14; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */

        .quiz-btn {
            background-color: var(--tg-theme-secondary-bg-color, #e9e9e9);
            color: var(--tg-theme-text-color, #000);
            margin-bottom: 5px;
        }
        .quiz-btn.correct { background-color: #28a745; color: white; }
        .quiz-btn.incorrect { background-color: #dc3545; color: white; }
        .final-quiz-btn {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
        }
        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .subheader {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #777);
            margin-bottom: 15px;
        }
        #result-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #e9e9e9);
            border-radius: 8px;
            margin-top: 10px;
        }
        #explanation-area {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #e9e9e9);
            border-radius: 8px;
        }
        #score-display {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù -->
    <div id="screen-main" class="screen-container">
        <div id="screen-main-content">
            <div class="header">–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –≤—Å–µ—Ö</div>
            <div class="subheader">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ</div>
            
            <button class="menu-btn" onclick="showScreen('screen-paragraph-select')">
                <span>üìñ</span> –í—ã–±–µ—Ä–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ (43 —à—Ç)
            </button>
            <button class="menu-btn" onclick="showScreen('screen-easy-quiz-select')">
                <span>üß†</span> –õ—ë–≥–∫–∏–π —Ç–µ—Å—Ç
            </button>
            <button class="menu-btn" onclick="showScreen('screen-hard-quiz-select')">
                <span>üí°</span> –¢—è–∂—ë–ª—ã–π —Ç–µ—Å—Ç
            </button>
            <button class="menu-btn" onclick="selectQuizSection('section-quiz', 'medium', 'sections', '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º', 'screen-main')">
                <span>üìù</span> –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º
            </button>
            <button class="menu-btn" onclick="selectQuizSection('final-quiz', 'medium', 'final', '–ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞', 'screen-main')">
                <span>üèÜ</span> –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
            </button>
            <button class="menu-btn" onclick="apiCall('prepare_mcqo')">
                <span>‚úçÔ∏è</span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ú–¶–ö–û
            </button>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∏ –±–ª–æ–∫ —Å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript'–æ–º –Ω–∏–∂–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ -->
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –í–´–ë–û–†–ê –ü–ê–†–ê–ì–†–ê–§–ê (–ß—Ç–µ–Ω–∏–µ) -->
    <div id="screen-paragraph-select" class="screen-container">
        <button class="menu-btn" onclick="showScreen('screen-main')">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="header">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –¥–ª—è —á—Ç–µ–Ω–∏—è</div>
        <div id="paragraph-buttons-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px;">
            <!-- –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –î–ï–ô–°–¢–í–ò–ô –° –ü–ê–†–ê–ì–†–ê–§–û–ú (–ß—Ç–µ–Ω–∏–µ) -->
    <div id="screen-paragraph-actions" class="screen-container">
        <button class="menu-btn" onclick="showScreen('screen-paragraph-select')">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="header" id="current-paragraph-title">–ü–∞—Ä–∞–≥—Ä–∞—Ñ X</div>
        <button class="menu-btn" onclick="apiCall('get_text')">–ß–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
        <button class="menu-btn" onclick="apiCall('get_summary')">–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</button>
        <button class="menu-btn" onclick="apiCall('get_qa')">–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</button>
        <button class="menu-btn" onclick="apiCall('get_dates')">–î–∞—Ç—ã</button>
        <button class="menu-btn" onclick="apiCall('get_terms')">–¢–µ—Ä–º–∏–Ω—ã</button>
        <button class="menu-btn" onclick="selectQuizParagraph(currentPId, 'easy', 'test', 'screen-paragraph-actions')">–ü—Ä–æ–π—Ç–∏ –õ—ë–≥–∫–∏–π —Ç–µ—Å—Ç</button>
        <button class="menu-btn" onclick="selectQuizParagraph(currentPId, 'hard', 'test', 'screen-paragraph-actions')">–ü—Ä–æ–π—Ç–∏ –¢—è–∂—ë–ª—ã–π —Ç–µ—Å—Ç</button>
    </div>

    <!-- –≠–ö–†–ê–ù–´ –í–´–ë–û–†–ê –¢–ï–°–¢–û–í (–õ–µ–≥–∫–∏–π/–¢—è–∂–µ–ª—ã–π) -->
    <div id="screen-easy-quiz-select" class="screen-container">
        <button class="menu-btn" onclick="showScreen('screen-main')">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="header">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –¥–ª—è –õ—ë–≥–∫–æ–≥–æ —Ç–µ—Å—Ç–∞</div>
        <div id="easy-buttons-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px;"></div>
    </div>

    <div id="screen-hard-quiz-select" class="screen-container">
        <button class="menu-btn" onclick="showScreen('screen-main')">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="header">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ –¥–ª—è –¢—è–∂—ë–ª–æ–≥–æ —Ç–µ—Å—Ç–∞</div>
        <div id="hard-buttons-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px;"></div>
    </div>

    <!-- –≠–ö–†–ê–ù –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –ó–ê–ü–£–°–ö–ê –¢–ï–°–¢–ê -->
    <div id="screen-quiz-start-confirmation" class="screen-container">
        <button class="menu-btn" id="back-from-quiz-confirm">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="header" id="quiz-confirm-title">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç?</div>
        <p id="quiz-confirm-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç?</p>
        <button class="menu-btn" onclick="startConfirmedTest()">–ù–∞—á–∞—Ç—å</button>
    </div>


    <!-- –û–ë–ï–†–¢–ö–ê –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í API CALL (—Ç–µ–∫—Å—Ç) –ò –¢–ï–°–¢–û–í (quiz) -->
    <div id="result-wrapper" class="screen-container">
        <button class="menu-btn" onclick="showScreen('screen-main')">‚Üê –í –º–µ–Ω—é</button>
        <button class="menu-btn copy-btn" onclick="copyToClipboard()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        <div id="result-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –¢–ï–°–¢–ê -->
        <div id="quiz-wrapper" style="display: none;">
            <div id="score-display">
                –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="score-correct">0</span> |
                –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="score-incorrect">0</span>
            </div>
            <div class="header" id="quiz-question">–í–æ–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            <div id="quiz-options">
                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
            </div>
            <div id="explanation-area">
                <div id="explanation-text"></div>
            </div>
            <div id="quiz-final-results" style="display: none;"></div>
            <button class="menu-btn" id="next-question-btn" onclick="loadNextQuestion()">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
            <!-- –ö–Ω–æ–ø–∫–∏ "–ù–æ–≤—ã–π —Ç–µ—Å—Ç" –∏ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ showFinalResults -->
        </div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let tg = null; 
        let currentPId = null; 
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ—Å—Ç–∞
        let currentTestAction = null; 
        let currentTestDifficulty = null;
        let currentTestSpecificId = null;
        let correctAnswersCount = 0;
        let incorrectAnswersCount = 0;
        let currentQuestionIndex = 0;
        let quizDataArray = []; 
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º —É—á–µ–±–Ω–∏–∫–∞
        const BOOK_CONTENTS = `
¬ß 1. –í–µ–ª–∏–∫–æ–µ –ø–µ—Ä–µ—Å–µ–ª–µ–Ω–∏–µ –Ω–∞—Ä–æ–¥–æ–≤. –í–æ—Å—Ç–æ—á–Ω–∞—è –ï–≤—Ä–æ–ø–∞ –∏ –°–µ–≤–µ—Ä–Ω–∞—è –ê–∑–∏—è –≤ 1-–º —Ç—ã—Å. –Ω. —ç. (p. 1)
¬ß 2‚Äì3. –í–æ—Å—Ç–æ—á–Ω—ã–µ —Å–ª–∞–≤—è–Ω–µ –∏ –∏—Ö —Å–æ—Å–µ–¥–∏ (p. 1)
¬ß 4. –ù–∞—á–∞–ª–æ –¥–∏–Ω–∞—Å—Ç–∏–∏ –†—é—Ä–∏–∫–æ–≤–∏—á–µ–π (p. 1)
¬ß 5‚Äì6. –†—É—Å—å –ø—Ä–∏ –ò–≥–æ—Ä–µ, –û–ª—å–≥–µ, –°–≤—è—Ç–æ—Å–ª–∞–≤–µ (p. 1)
¬ß 7‚Äì8. –†—É—Å—å –ø—Ä–∏ –í–ª–∞–¥–∏–º–∏—Ä–µ –°–≤—è—Ç–æ–º (p. 1)
¬ß 9. –†–∞—Å—Ü–≤–µ—Ç –†—É—Å–∏ –ø—Ä–∏ –Ø—Ä–æ—Å–ª–∞–≤–µ –ú—É–¥—Ä–æ–º (p. 1)
¬ß 10‚Äì11. –ù–∞—Å–ª–µ–¥–Ω–∏–∫–∏ –Ø—Ä–æ—Å–ª–∞–≤–∞ –ú—É–¥—Ä–æ–≥–æ (p. 1)
¬ß 12. –†—É—Å—å –ø—Ä–∏ –í–ª–∞–¥–∏–º–∏—Ä–µ –ú–æ–Ω–æ–º–∞—Ö–µ (p. 1)
¬ß 13. –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–¥—Ä–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å –†—É—Å–∏ (p. 1)
¬ß 14‚Äì15. –í–ª–∞–¥–∏–º–∏—Ä–æ-–°—É–∑–¥–∞–ª—å—Å–∫–∞—è –∑–µ–º–ª—è (p. 1)
¬ß 16‚Äì17. –ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –∑–µ–º–ª—è (p. 1)
¬ß 18. –Æ–≥–æ-–ó–∞–ø–∞–¥–Ω–∞—è –†—É—Å—å (p. 1)
¬ß 19‚Äì20. –ö—É–ª—å—Ç—É—Ä–∞ –∏ –±—ã—Ç –≤ IX ‚Äî –Ω–∞—á–∞–ª–µ XIII –≤. (p. 1)
¬ß 21. –ß–∏–Ω–≥–∏—Å—Ö–∞–Ω –∏ –µ–≥–æ –∏–º–ø–µ—Ä–∏—è (p. 1)
¬ß 22‚Äì23. –ù–∞—Ç–∏—Å–∫ –Ω–∞ —Ä—É—Å—Å–∫–∏–µ –∑–µ–º–ª–∏ —Å –≤–æ—Å—Ç–æ–∫–∞ (p. 1)
¬ß 24‚Äì25. –û—Ç—Ä–∞–∂–µ–Ω–∏–µ –∞–≥—Ä–µ—Å—Å–∏–∏ —Å –∑–∞–ø–∞–¥–∞ (p. 1)
¬ß 26‚Äì27. –†—É—Å—Å–∫–∏–µ –∑–µ–º–ª–∏ –∏ –ó–æ–ª–æ—Ç–∞—è –û—Ä–¥–∞ (p. 1)
¬ß 28‚Äì29. –†—É—Å—å –∏ –í–µ–ª–∏–∫–æ–µ –∫–Ω—è–∂–µ—Å—Ç–≤–æ –õ–∏—Ç–æ–≤—Å–∫–æ–µ (p. 2)
¬ß 30. –°–µ–≤–µ—Ä–æ-–í–æ—Å—Ç–æ—á–Ω–∞—è –†—É—Å—å –≤ –∫–æ–Ω—Ü–µ XIII ‚Äî –Ω–∞—á–∞–ª–µ XIV –≤. (p. 2)
¬ß 31. –í–æ–∑–≤—ã—à–µ–Ω–∏–µ –ú–æ—Å–∫–≤—ã (p. 2)
¬ß 32‚Äì33. –ü–æ–±–µ–¥–∞ –Ω–∞ –ö—É–ª–∏–∫–æ–≤–æ–º –ø–æ–ª–µ (p. 2)
¬ß 34‚Äì35. –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –∫–Ω—è–∂–µ—Å—Ç–≤–æ –≤ –∫–æ–Ω—Ü–µ XIV ‚Äî –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ XV –≤. (p. 2)
¬ß 36‚Äì37. –ò–≤–∞–Ω III ‚Äî –≥–æ—Å—É–¥–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏ (p. 2)
¬ß 38‚Äì39. –†–æ—Å—Å–∏–π—Å–∫–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ –∏ –æ–±—â–µ—Å—Ç–≤–æ –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ XV –≤. (p. 2)
¬ß 40‚Äì41. –ü—Ä–∞–≤–ª–µ–Ω–∏–µ –í–∞—Å–∏–ª–∏—è III (p. 2)
¬ß 42‚Äì43. –ö—É–ª—å—Ç—É—Ä–∞ –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ XIII ‚Äî –ø–µ—Ä–≤–æ–π —Ç—Ä–µ—Ç–∏ XVI –≤. (p. 2)
`.trim(); // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ

        function showScreen(screenId) {
         document.querySelectorAll('.screen-container').forEach(el => el.style.display = 'none');
         document.getElementById('result-wrapper').style.display = 'none';
         document.getElementById('quiz-wrapper').style.display = 'none'; 
         document.getElementById('explanation-area').style.display = 'none';
         document.getElementById('result-text').style.display = 'block'; 
         document.querySelector('.copy-btn').style.display = 'block'; 
         if (tg) tg.HapticFeedback.impactOccurred('light');
         document.getElementById(screenId).style.display = 'flex';
        }
        // –≠–¢–ê –§–£–ù–ö–¶–ò–Ø –¢–ï–ü–ï–†–¨ –û–¢–í–ï–ß–ê–ï–¢ –ó–ê –ü–ï–†–ï–•–û–î –ù–ê –≠–ö–†–ê–ù –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –¢–ï–°–¢–ê
        function selectQuizParagraph(pId, difficulty, action, returnScreenId) {
        currentTestAction = action;
        currentTestDifficulty = difficulty;
        currentTestSpecificId = pId.toString();
        currentPId = pId; // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º currentPId –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏
        document.getElementById('quiz-confirm-title').innerText = `${difficulty === 'easy' ? '–õ—ë–≥–∫–∏–π' : 
        '–¢—è–∂—ë–ª—ã–π'} —Ç–µ—Å—Ç: –ü–∞—Ä–∞–≥—Ä–∞—Ñ ${pId}`;
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ "–Ω–∞–∑–∞–¥" –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        document.getElementById('back-from-quiz-confirm').onclick = () => showScreen(returnScreenId);
        showScreen('screen-quiz-start-confirmation');
        }
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function startConfirmedTest() {
        if (currentTestAction && currentTestSpecificId) {
         apiCall(currentTestAction, currentTestDifficulty, currentTestSpecificId);
        } else { 
         alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–µ—Å—Ç–∞.");
         showScreen('screen-main');
        }
        } // <-- –ó–¥–µ—Å—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è startConfirmedTest
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
        function selectQuizSection(action, difficulty, specificId, titleText, returnScreenId) {
         currentTestAction = action;
         currentTestDifficulty = difficulty;
         currentTestSpecificId = specificId;
         currentPId = specificId;
         document.getElementById('quiz-confirm-title').innerText = `${titleText}`;
         document.getElementById('quiz-confirm-text').innerText = `–ù–∞—á–∞—Ç—å ${titleText} (${specificId})?`;
         document.getElementById('back-from-quiz-confirm').onclick = () => showScreen(returnScreenId);
         showScreen('screen-quiz-start-confirmation');
        }
        function generateParagraphButtons() {
        const grid = document.getElementById('paragraph-buttons-grid');
        for (let i = 1; i <= 43; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.onclick = () => selectParagraph(i);
        grid.appendChild(button);
        }
        }
        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –≤—ã–∑—ã–≤–∞–µ—Ç selectQuizParagraph –≤–º–µ—Å—Ç–æ apiCall –Ω–∞–ø—Ä—è–º—É—é
        function generateQuizButtons(containerId, difficulty, returnScreenId) {
        const grid = document.getElementById(containerId);
        if (!grid) return;
        grid.innerHTML = '';
        for (let i = 1; i <= 43; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        // –¢–µ–ø–µ—Ä—å onclick –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω
        button.onclick = () => selectQuizParagraph(i, difficulty, 'test', returnScreenId); 
        grid.appendChild(button);
        }
        }
        function selectParagraph(pId) {
        currentPId = pId;
        document.getElementById('current-paragraph-title').innerText = `–ü–∞—Ä–∞–≥—Ä–∞—Ñ ${currentPId}`;
        showScreen('screen-paragraph-actions');
        }
        // !!! –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø API CALL –û–°–¢–ê–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –õ–û–ì–ò–ö–ï !!!
        async function apiCall(action, difficulty = 'medium', specificId = null) {
        const display = document.getElementById('result-text');
        const quizWrapper = document.getElementById('quiz-wrapper');
        const resultWrapper = document.getElementById('result-wrapper');
        const buttons = document.querySelectorAll('button');
        buttons.forEach(b => b.disabled = true);
        display.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        resultWrapper.style.display = 'block';
        quizWrapper.style.display = 'none'; 
        document.querySelector('.copy-btn').style.display = 'none'; 
        display.style.display = 'block';
        if (action.includes('test') || action.includes('quiz')) {
         currentTestAction = action;
         currentTestDifficulty = difficulty;
         currentTestSpecificId = specificId;
        } else {
         currentTestAction = null;
         currentTestDifficulty = null;
         currentTestSpecificId = null;
        }
        try {
         const targetUrl = 'https://hisedu.app.n8n.cloud/webhook/6b2e1e97-a736-4593-9263-817bf345391f'; 
         let finalPId = specificId || currentPId || 'N/A';
         // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä dataType –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ n8n
         const dataType = (difficulty === 'hard') ? 'Quiz_JSON hard' : ''; 
         const url = 
          
        `${targetUrl}?id=${finalPId}&action=${action}&diff=${difficulty}&dataType=${encodeURIComponent(dataType)}&auth=${encodeURIComponent(tg.initData)}`;
         const response = await fetch(url);
         const dataString = await response.text(); 
         const quizDataArrayParsed = tryParseJson(dataString);
         if (Array.isArray(quizDataArrayParsed) && quizDataArrayParsed.length >= 10) { 
          display.style.display = 'none'; 
          startQuiz(quizDataArrayParsed); 
          document.querySelector('.copy-btn').style.display = 'none'; 
          } else {
          display.style.display = 'block';
          display.innerText = dataString;
          document.querySelector('.copy-btn').style.display = 'block'; 
          quizWrapper.style.display = 'none'; 
          }
          } catch (error) {
          alert('–û—à–∏–±–∫–∞ API: ' + error.message);
          display.innerText = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ API: " + error.message;
          display.style.display = 'block';
          quizWrapper.style.display = 'none';
          document.querySelector('.copy-btn').style.display = 'none';
          } finally {
          buttons.forEach(b => b.disabled = false);
          }
        }
        function copyToClipboard() {
        const resultTextElement = document.getElementById('result-text');
        const textToCopy = resultTextElement.textContent || resultTextElement.innerText;
        if (textToCopy) {
        navigator.clipboard.writeText(textToCopy).then(() => {
        const copyBtn = document.querySelector('.copy-btn');
        copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        if (tg) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => {
        copyBtn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç';
        }, 2000);
        }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.');
        });
        }
        }
        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ê–†–°–ò–ù–ì–ê JSON (–û–ë–ù–û–í–õ–ï–ù–û) ---
        function tryParseJson(str) {
        try {
        const json = JSON.parse(str);
        if (typeof json === 'object' && json !== null) {
        if (json.quizQuestions && Array.isArray(json.quizQuestions)) {
        return json.quizQuestions;
        }
        return json;
        }
        } catch (e) {
        }
        return null;
        }
        // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ï–°–¢–ê (–†–ê–ë–û–¢–ê –° –ú–ê–°–°–ò–í–û–ú –ò –°–ß–ï–¢–û–ú) ---
        function startQuiz(quizArray) { 
        quizDataArray = quizArray;
        currentQuestionIndex = 0;
        resetQuizScore(); 
        loadQuestion(currentQuestionIndex);
        // –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–µ—Ä—Ç–∫—É —Ç–µ—Å—Ç–∞
        document.getElementById('screen-quiz-start-confirmation').style.display = 'none';
        document.getElementById('quiz-wrapper').style.display = 'block';
        const newTestBtn = document.getElementById('new-test-btn');
        if (newTestBtn) { newTestBtn.style.display = 'none'; }
        }
        /**
        * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –í–û–ü–†–û–°–ê
        */
        function loadQuestion(index) {
        if (index >= quizDataArray.length) {
         showFinalResults();
         return;
        }
        const data = quizDataArray[index];
        const optionsEl = document.getElementById('quiz-options');
        const explanationArea = document.getElementById('explanation-area');
        const finalResultsEl = document.getElementById('quiz-final-results');
        const nextBtn = document.getElementById('next-question-btn');
        document.getElementById('quiz-question').innerText = `–í–æ–ø—Ä–æ—Å ${index + 1}: ${data.q}`;
        optionsEl.innerHTML = '';
        explanationArea.style.display = 'none';
        finalResultsEl.style.display = 'none';
        nextBtn.style.display = 'none'; 
        const answersTitle = document.createElement('h4');
        answersTitle.innerText = '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤';
        answersTitle.style.marginBottom = '10px';
        answersTitle.style.color = 'var(--text-color)';
        optionsEl.appendChild(answersTitle);
        data.a.forEach((optionText, optionIndex) => {
         const btn = document.createElement('button');
         btn.innerText = `${optionIndex + 1}. ${optionText}`;
         btn.classList.add('quiz-btn');
         
         btn.onclick = () => {
         const allBtns = optionsEl.querySelectorAll('button');
         allBtns.forEach(b => b.disabled = true);
         if (optionIndex === data.c) {
          btn.classList.add('correct');
          correctAnswersCount++;
          } else {
          btn.classList.add('incorrect');
          allBtns[data.c].classList.add('correct');
          incorrectAnswersCount++;
          }
          document.getElementById('score-correct').innerText = correctAnswersCount;
          document.getElementById('score-incorrect').innerText = incorrectAnswersCount;
          // –£–î–ê–õ–ï–ù–ò–ï –°–õ–û–í–ê "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:"
          document.getElementById('explanation-text').innerText = data.e; 
          document.getElementById('explanation-area').style.display = 'block';
          nextBtn.style.display = 'block';
          explanationArea.scrollIntoView({ behavior: 'smooth' });
          };
          optionsEl.appendChild(btn);
        });
        }
        function loadNextQuestion() {
        currentQuestionIndex++;
        loadQuestion(currentQuestionIndex);
        }
        function resetQuizScore() {
        correctAnswersCount = 0;
        incorrectAnswersCount = 0;
        document.getElementById('score-correct').innerText = 0;
        document.getElementById('score-incorrect').innerText = 0;
        }
        function resetQuizAndStartOver() {
        resetQuizScore();
        currentQuestionIndex = 0;
        if (quizDataArray.length > 0) {
        loadQuestion(currentQuestionIndex);
        } else {
        document.getElementById('quiz-wrapper').style.display = 'none';
        }
        const newTestBtn = document.getElementById('new-test-btn');
        if (newTestBtn) { newTestBtn.style.display = 'none'; }
        }
        function startNewTestFromEnd() {
        if (currentTestAction && currentTestDifficulty) {
         apiCall(currentTestAction, currentTestDifficulty, currentTestSpecificId);
         document.getElementById('quiz-final-results').style.display = 'none';
         const newTestBtn = document.getElementById('new-test-btn');
         if (newTestBtn) {
          newTestBtn.style.display = 'none';
         
        } else {
         alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∏–∑ –º–µ–Ω—é.");
         showScreen('screen-main');
        }
        }
        function showFinalResults() {
        const questionEl = document.getElementById('quiz-question');
        const optionsEl = document.getElementById('quiz-options');
        const explanationArea = document.getElementById('explanation-area');
        const nextBtn = document.getElementById('next-question-btn');
        const finalResultsEl = document.getElementById('quiz-final-results');
        questionEl.innerText = `–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–∞—à –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç: ${correctAnswersCount} –∏–∑ 
        ${quizDataArray.length}.`;
        optionsEl.innerHTML = '';
        explanationArea.style.display = 'none';
        nextBtn.style.display = 'none';
        finalResultsEl.innerText = '–ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é.';
        finalResultsEl.style.display = 'block';
        let newTestBtn = document.getElementById('new-test-btn');
        if (!newTestBtn) {
        newTestBtn = document.createElement('button');
        newTestBtn.id = 'new-test-btn';
        newTestBtn.innerText = '–ù–æ–≤—ã–π —Ç–µ—Å—Ç';
        newTestBtn.classList.add('final-quiz-btn'); 
        newTestBtn.onclick = startNewTestFromEnd;
        document.getElementById('quiz-wrapper').appendChild(newTestBtn); 
        }
        newTestBtn.style.display = 'block';

        // –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "–ù–ê–ó–ê–î –í –ú–ï–ù–Æ"
        let backToMenuBtn = document.getElementById('back-to-menu-btn');
        if (!backToMenuBtn) {
            backToMenuBtn = document.createElement('button');
            backToMenuBtn.id = 'back-to-menu-btn';
            backToMenuBtn.innerText = '‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é';
            backToMenuBtn.classList.add('final-quiz-btn');
            backToMenuBtn.style.marginTop = '10px';
            backToMenuBtn.style.backgroundColor = '#6c757d'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∏—á–∏—è
            backToMenuBtn.onclick = () => showScreen('screen-main');
            document.getElementById('quiz-wrapper').appendChild(backToMenuBtn);
        }
        backToMenuBtn.style.display = 'block';

        }

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–ù–û–ü–ö–ò "–°–û–î–ï–†–ñ–ê–ù–ò–ï" - —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–∞
        function toggleContents() {
            const contentsDisplay = document.getElementById('contents-display');
            const button = document.getElementById('contents-button');
            if (contentsDisplay.style.display === 'none' || contentsDisplay.style.display === '') {
                contentsDisplay.style.display = 'block';
                button.innerText = '–°–∫—Ä—ã—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ';
            } else {
                contentsDisplay.style.display = 'none';
                button.innerText = '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞ –ø–æ –ò—Å—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏ –∑–∞ 6 –∫–ª–∞—Å—Å (–∞–≤—Ç–æ—Ä –í. –†. –ú–µ–¥–∏–Ω—Å–∫–∏–π, –ê. –í. –¢–æ—Ä–∫—É–Ω–æ–≤)';
            }
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
        function initWebApp() {
        if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp; 
        tg.expand();
        tg.ready();
        generateParagraphButtons();
        // –ü–µ—Ä–µ–¥–∞–µ–º ID —ç–∫—Ä–∞–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
        generateQuizButtons('easy-buttons-grid', 'easy', 'screen-easy-quiz-select');
        generateQuizButtons('hard-buttons-grid', 'hard', 'screen-hard-quiz-select');

        // –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ô –ö–ù–û–ü–ö–ò –ò –ë–õ–û–ö–ê –° –°–û–î–ï–†–ñ–ê–ù–ò–ï–ú –ù–ê –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù –í–ù–ò–ó–£
        const mainScreenContent = document.getElementById('screen-main-content');
        if (mainScreenContent) {
            // 1. –ö–Ω–æ–ø–∫–∞
            const contentsButton = document.createElement('button');
            contentsButton.id = 'contents-button';
            contentsButton.innerText = '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—á–µ–±–Ω–∏–∫–∞ –ø–æ –ò—Å—Ç–æ—Ä–∏–∏ –†–æ—Å—Å–∏–∏ –∑–∞ 6 –∫–ª–∞—Å—Å (–∞–≤—Ç–æ—Ä –í. –†. –ú–µ–¥–∏–Ω—Å–∫–∏–π, –ê. –í. –¢–æ—Ä–∫—É–Ω–æ–≤)';
            contentsButton.classList.add('menu-btn'); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞ —Å—Ç–∏–ª–µ–π
            contentsButton.onclick = toggleContents;
            contentsButton.style.marginTop = 'auto'; // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑
            mainScreenContent.appendChild(contentsButton);

            // 2. –ë–ª–æ–∫ —Å —Ç–µ–∫—Å—Ç–æ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            const contentsDisplay = document.createElement('div');
            contentsDisplay.id = 'contents-display';
            contentsDisplay.style.whiteSpace = 'pre-wrap'; // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            contentsDisplay.style.textAlign = 'left';
            contentsDisplay.style.padding = '10px';
            contentsDisplay.style.marginTop = '10px';
            contentsDisplay.style.borderTop = '1px solid #ccc';
            contentsDisplay.style.display = 'none'; // –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            contentsDisplay.innerText = BOOK_CONTENTS;
            mainScreenContent.appendChild(contentsDisplay);
        }

        showScreen('screen-main');
        } else {
        setTimeout(initWebApp, 100); 
        }
        }
        initWebApp();
    </script>
</body>
</html>




